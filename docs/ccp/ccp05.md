# 第五章 输入输出系统

### 5.1 概述

一、输入输出系统的发展概况

1.早期

分散连接

CPU和I/O设备串行工作    程序查询方式

2.接口模块和DMA阶段

总线连接

CPU和I/O设备并行工作    中断方式、DMA方式

3.具有通道结构的阶段

二、输入输出系统的组成

1. I/O软件
    1. I/O指令：CPU指令的一部分
    2. 通道指令：通道自身的指令
2. I/O硬件
   1. 设备  I/O接口
   2. 设备  设备控制器  通道

三、I/O设备与主机的联系方式

1. I/O设备编制方式
    1. 统一编址     用取数、存数指令
    2. 不统一编址   有专门的I/O指令

2. 设备选址

用设备选择电路识别是否被选中

3. 传送方式
    1. 串行
    2. 并行

4. 联络方式
    1. 立即响应
    2. 异步工作采用应答信号

    ![ccp05-01](/images/ccp05-01.png ':size=50%')

    3. 同步工作采用同步时标

5. I/O设备与主机的连接方式
   1. 辐射式连接：每台设备都配有一套控制线路和一组信号线，不便于增删设备
   2. 总线连接：便于增删设备

四、I/O设备与主机信息传送的控制方式

1.程序查询方式

由CPU通过程序不断查询I/O设备是否已做好准备，从而控制I/O设备与主机交换信息

![ccp05-02](/images/ccp05-02.png ':size=30%')

**CPU和I/O串行工作，踏步等待**

2.程序中断方式

I/O工作：
+ 自身准备  CPU不查询
+ 与主机交换信息    CPU暂停现行程序

**没有踏步等待现象，中断现行程序**

3.DMA方式

主存和I/O之间有一条直接数据通道

**不中断现行程序**

周期挪用(周期窃取)

CPU和I/O并行工作

![ccp05-03](/images/ccp05-03.png ':size=70%')


### 5.2 外部设备

I/O设备大致分为三类：
1. 人机交互设备     键盘、鼠标、打印机、显示器
2. 计算机信息存储设备       磁盘、光盘、磁带
3. 机-机通信设备        调制解调器等

输入设备：
1. 键盘
2. 鼠标
3. 触摸屏

输出设备：
1. 显示器
2. 打印机

其他：
1. A/D、D/A     模拟/数字（数字/模拟）转换器
2. 终端     由键盘和显示器组成
3. 汉字处理     汉字输入、汉字存储、汉字输出

多媒体技术

数据的压缩解压缩、专用芯片、语音识别、图像识别等

### 5.3 I/O接口

一、概述

为什么要设置接口？
1. 实现设备的选择
2. 实现数据缓冲达到速度匹配
3. 实现数据串-并格式转换
4. 实现电平转换
5. 传送控制命令
6. 反应设备的状态(“忙”、“就绪”、“中断请求”)

二、接口的功能和组成

1.总线连接方式的I/O接口电路

![ccp05-04](/images/ccp05-04.png ':size=50%')

2.接口的功能和组成

| 功能 | 组成 |
| ---- | ---- |
| 选址功能 | 设备选择电路 |
| 传送命令的功能 | 命令寄存器、命令译码器 |
| 传送数据的功能 | 数据缓冲寄存器 |
| 反应设备状态的功能 | 设备状态标记 |

+ 完成触发器 D
+ 工作触发器 B
+ 中断请求触发器 INTR
+ 屏蔽触发器 MASK

3.I/O接口的基本组成

![ccp05-05](/images/ccp05-05.png ':size=60%')

三、接口类型

1. 按数据传送方式分类
   + 并行接口
   + 串行接口
2. 按功能选择的灵活性分类
   + 可编程接口
   + 不可编程接口
3. 按通用性分类
   + 通用接口
   + 专用接口
4. 按数据传送的控制方式分类
   + 中断接口
   + DMA接口

### 5.4 程序查询方式

一、程序查询流程

1.查询流程

![ccp05-06](/images/ccp05-06.png ':size=80%')

2.程序流程

![ccp05-07](/images/ccp05-07.png ':size=30%')

二、程序查询方式的接口电路

![ccp05-08](/images/ccp05-08.png ':size=50%')


### 5.5 程序中断方式

程序中断方式的接口电路

1.配置中断请求触发器和中断屏蔽触发器

![ccp05-09](/images/ccp05-09.png ':size=50%')

2.排队器
+ 硬件：在CPU内或在接口电路中（链式排队器）
+ 软件

![ccp05-10](/images/ccp05-10.png ':size=60%')


3.中断向量地址形成部件
+ 由软件产生
+ 硬件向量法：由硬件产生向量地址，再由向量地址找到入口地址


4.程序中断方式接口电路的基本组成

![ccp05-11](/images/ccp05-11.png ':size=60%')

I/O中断处理过程

CPU响应中断的条件和时间

条件：
+ 允许中断触发器 EINT=1
+ 用开中断指令将 EINT置“1”
+ 用关中断指令将 EINT置“0”或硬件自动复位

时间：
+ 当D=1(随机)且MASK=0时在每条指令执行阶段的结束前CPU发中断查询信号(将 INTR置为“1”)

中断服务程序流程

1. 保护现场
   + 程序断点的保护     中断隐指令完成
   + 寄存器内容的保护   进栈指令
2. 中断服务
   + 对不同的I/O设备具有不同内容的设备服务 
3. 恢复现场
   + 出栈指令
4. 中断返回
   + 中断返回指令

单重中断和多重中断

+ 单重中断：不允许中断现行的中断服务程序
+ 多重中断：允许级别更高的中断源中断现行的中断服务程序

### 5.6 DMA方式

一、DMA方式的特点

DMA与主存交换数据的三种方式
1. 停止CPU访问主存      
   + 控制简单
   + CPU处于不工作状态或保持状态
   + 未充分发挥CPU对主存的利用率
2. 周期挪用(或周期窃取)
   + DMA访问主存有三种可能：CPU此时不访存、CPU正在访存、CPU与DMA同时请求访存，此时CPU将总线控制权让给DMA 
3. DMA与CPU交替访问
   + 不需要申请建立和归还总线的使用权

二、DMA接口的功能和组成

1.DMA接口功能
   1. 向CPU申请DMA传送
   2. 处理总线控制权的转交
   3. 管理系统总线、控制数据传送
   4. 确定数据传送的首地址和长度，修正传送过程中的数据地址和长度
   5. DMA传送结束时，给出操作完成信号

2.DMA接口组成
   1. 主存地址寄存器(AR)
   2. 字计数器(WC)
   3. 数据缓冲寄存器(BR)
   4. DMA控制逻辑
   5. 中断机构
   6. 设备地址寄存器(DAR)

三、DMA的工作过程

1.DMA传送过程

预处理、数据传送、后处理

(1)预处理

通过几条输入输出指令预置如下信息
+ 通知DMA控制逻辑传送方向(入/出)
+ 设备地址：DMA的DAR
+ 主存地址：DMA的AR
+ 传送字数：DMA的WC

(2)DMA传送过程

![ccp05-12](/images/ccp05-12.png ':size=60%')

(3)后处理
+ 校验送入主存的数是否正确
+ 是否继续用DMA
+ 测试传送过程是否正确，错则转诊断程序
+ 由中断服务程序完成

2.DMA接口与系统的连接方式

具有公共请求线的DMA请求

![ccp05-13](/images/ccp05-13.png ':size=60%')

独立的DMA请求

![ccp05-14](/images/ccp05-14.png ':size=50%')

3.DMA方式与程序中断方式的比较

|  | 中断方式 | DMA方式 |
| --- | --- | --- |
| 数据传送 | 程序 | 硬件 |
| 响应时间 | 指令执行结束 | 存取周期结束 |
| 处理异常情况 | 能 | 不能 |
| 中断请求 | 传送数据 | 后处理 |
| 优先级 | 低 | 高 |

四、DMA接口的类型

1.选择型

在物理上连接多个设备，在逻辑上只允许连接一个设备

2.多路型

在物理上连接多个设备，在逻辑上允许连接多个设备同时工作

